I"ñ*<p>å¶å°”ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Lambda è¡¨è¾¾å¼ä¸­ä¿®æ”¹å˜é‡çš„å€¼ï¼Œä½†å¦‚æœç›´æ¥å°è¯•ä¿®æ”¹çš„è¯ï¼Œç¼–è¯‘å™¨ä¸ä¼šè§†è€Œä¸è§å¬è€Œä¸é—»ï¼Œå®ƒä¼šè­¦å‘Šæˆ‘ä»¬è¯´ï¼šâ€œvariable used in lambda expression should be final or effectively finalâ€ã€‚</p>

<!--more-->

<p><img src="http://www.itwanger.com/assets/images/2020/02/java-lambda-final-modify-01.png" alt="" /></p>

<p>è¿™ä¸ªé—®é¢˜å‘ç”Ÿçš„åŸå› æ˜¯å› ä¸º Java è§„èŒƒä¸­æ˜¯è¿™æ ·è§„å®šçš„ï¼š</p>

<blockquote>
  <p>Any local variable, formal parameter, or exception parameter used but not declared in a lambda expression
must either be declared final or be effectively finalÂ <a href="http://docs.oracle.com/javase/specs/jls/se8/html/jls-4.html#jls-4.12.4">(Â§4.12.4)</a>,
or a compile-time error occurs where the use is attempted.</p>
</blockquote>

<p>å¤§è‡´çš„æ„æ€å°±æ˜¯è¯´ï¼ŒLambda è¡¨è¾¾å¼ä¸­è¦ç”¨åˆ°çš„ï¼Œä½†åˆæœªåœ¨ Lambda è¡¨è¾¾å¼ä¸­å£°æ˜çš„å˜é‡ï¼Œå¿…é¡»å£°æ˜ä¸º final æˆ–è€…æ˜¯ effectively finalï¼Œå¦åˆ™å°±ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯ã€‚</p>

<p>å…³äº final å’Œ effectively final çš„åŒºåˆ«ï¼Œå¯èƒ½æœ‰äº›å°ä¼™ä¼´ä¸å¤ªæ¸…æ¥šï¼Œè¿™é‡Œå¤šè¯´ä¸¤å¥ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kt">int</span> <span class="n">a</span><span class="o">;</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
<span class="c1">// a = 2;</span>
<span class="c1">// ç”±äº a æ˜¯ final çš„ï¼Œæ‰€ä»¥ä¸èƒ½è¢«é‡æ–°èµ‹å€¼</span>

<span class="kt">int</span> <span class="n">b</span><span class="o">;</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
<span class="c1">// b æ­¤åå†æœªæ›´æ”¹</span>
<span class="c1">// b å°±æ˜¯ effectively final</span>

<span class="kt">int</span> <span class="n">c</span><span class="o">;</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
<span class="c1">// c å…ˆè¢«èµ‹å€¼ä¸º 1ï¼Œéšååˆè¢«é‡æ–°èµ‹å€¼ä¸º 2</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
<span class="c1">// c å°±ä¸æ˜¯ effectively final</span>
</code></pre></div></div>

<p>æ˜ç™½äº† final å’Œ effectively final çš„åŒºåˆ«åï¼Œæˆ‘ä»¬äº†è§£åˆ°ï¼Œå¦‚æœæŠŠ limit å®šä¹‰ä¸º finalï¼Œé‚£å°±æ— æ³•åœ¨ Lambda è¡¨è¾¾å¼ä¸­ä¿®æ”¹å˜é‡çš„å€¼ã€‚é‚£æœ‰ä»€ä¹ˆå¥½çš„è§£å†³åŠæ³•å‘¢ï¼Ÿæ—¢èƒ½è®©ç¼–è¯‘å™¨ä¸å‘å‡ºè­¦å‘Šï¼Œåˆèƒ½ä¿®æ”¹å˜é‡çš„å€¼ã€‚</p>

<p>æ€å‰æƒ³åï¼Œè¯•æ¥è¯•å»ï¼Œæˆ‘ç»ˆäºæ‰¾åˆ°äº† 3 ä¸ªå¯è¡Œçš„è§£å†³æ–¹æ¡ˆï¼š</p>

<p>1ï¼‰æŠŠ limit å˜é‡å£°æ˜ä¸º staticã€‚</p>

<p>2ï¼‰æŠŠ limit å˜é‡å£°æ˜ä¸º AtomicIntegerã€‚</p>

<p>3ï¼‰ä½¿ç”¨æ•°ç»„ã€‚</p>

<p>ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†åœ°ä¸€ä¸€ä»‹ç»ä¸‹ã€‚</p>

<h3 id="01æŠŠ-limit-å˜é‡å£°æ˜ä¸º-static">01ã€æŠŠ limit å˜é‡å£°æ˜ä¸º static</h3>

<p>è¦æƒ³æŠŠ limit å˜é‡å£°æ˜ä¸º staticï¼Œå°±å¿…é¡»å°† limit å˜é‡æ”¾åœ¨ <code class="highlighter-rouge">main()</code> æ–¹æ³•å¤–éƒ¨ï¼Œå› ä¸º <code class="highlighter-rouge">main()</code> æ–¹æ³•æœ¬èº«æ˜¯ static çš„ã€‚å®Œæ•´çš„ä»£ç ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ModifyVariable2StaticInsideLambda</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æ¥çœ‹ä¸€ä¸‹ç¨‹åºè¾“å‡ºçš„ç»“æœï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0
1
2
3
4
</code></pre></div></div>

<p>OKï¼Œè¯¥æ–¹æ¡ˆæ˜¯å¯è¡Œçš„ã€‚</p>

<h3 id="02æŠŠ-limit-å˜é‡å£°æ˜ä¸º-atomicinteger">02ã€æŠŠ limit å˜é‡å£°æ˜ä¸º AtomicInteger</h3>

<p>AtomicInteger å¯ä»¥ç¡®ä¿ int å€¼çš„ä¿®æ”¹æ˜¯åŸå­æ€§çš„ï¼Œå¯ä»¥ä½¿ç”¨ <code class="highlighter-rouge">set()</code> æ–¹æ³•è®¾ç½®ä¸€ä¸ªæ–°çš„ int å€¼ï¼Œ<code class="highlighter-rouge">get()</code> æ–¹æ³•è·å–å½“å‰çš„ int å€¼ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ModifyVariable2AtomicInsideLambda</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">AtomicInteger</span> <span class="n">limit</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
        <span class="nc">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">limit</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">.</span><span class="na">get</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æ¥çœ‹ä¸€ä¸‹ç¨‹åºè¾“å‡ºçš„ç»“æœï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0
1
2
3
4
</code></pre></div></div>

<p>OKï¼Œè¯¥æ–¹æ¡ˆä¹Ÿæ˜¯å¯è¡Œçš„ã€‚</p>

<h3 id="03ä½¿ç”¨æ•°ç»„">03ã€ä½¿ç”¨æ•°ç»„</h3>

<p>ä½¿ç”¨æ•°ç»„çš„æ–¹å¼ç•¥å¸¦ä¸€äº›æ¬ºéª—çš„æ€§è´¨ï¼Œåœ¨å£°æ˜æ•°ç»„çš„æ—¶å€™è®¾ç½®ä¸º finalï¼Œä½†æ›´æ”¹ int çš„å€¼æ—¶å´ä¿®æ”¹çš„æ˜¯æ•°ç»„çš„ä¸€ä¸ªå…ƒç´ ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ModifyVariable2ArrayInsideLambda</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="o">[]</span> <span class="n">limits</span> <span class="o">=</span> <span class="o">{</span><span class="mi">10</span><span class="o">};</span>
        <span class="nc">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">limits</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limits</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æ¥çœ‹ä¸€ä¸‹ç¨‹åºè¾“å‡ºçš„ç»“æœï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0
1
2
3
4
</code></pre></div></div>

<p>OKï¼Œè¯¥æ–¹æ¡ˆä¹Ÿæ˜¯å¯è¡Œçš„ã€‚</p>

<h3 id="04é¸£è°¢">04ã€é¸£è°¢</h3>

<p>å¥½äº†ï¼Œäº²çˆ±çš„è¯»è€…æœ‹å‹ï¼Œä»¥ä¸Šå°±æ˜¯æœ¬æ–‡çš„å…¨éƒ¨å†…å®¹äº†ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰æŒºæœ‰æ„æ€çš„ï¼Œç¼–è¯‘å™¨å‘Šè¯‰æˆ‘ä»¬è¦ç”¨ final ä¿®é¥° Lambda è¡¨è¾¾å¼å¤–çš„å˜é‡ï¼Œä½†æˆ‘ä»¬å´æ‰¾åˆ°äº†å…¶ä»–çš„è§£å†³æ–¹æ¡ˆï¼Œè¿˜ä¸€æ‰¾å°±æ˜¯ 3 ä¸ªï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰æŠ€èƒ½åŒ…åˆå‡çº§äº†ï¼Œæœ‰æ²¡æœ‰ï¼Ÿä¼¸å‡ºå°æ‰‹ç»™è‡ªå·±ç‚¹ä¸ªèµğŸ‘å§ã€‚</p>

<p>PSï¼šæœ¬ç¯‡æ–‡ç« ä¸­çš„ç¤ºä¾‹ä»£ç å·²ç»åŒæ­¥åˆ°ç äº‘ï¼Œ<a href="https://gitee.com/qing_gee/JavaPoint/tree/master">ä¼ é€é—¨~</a></p>
:ET