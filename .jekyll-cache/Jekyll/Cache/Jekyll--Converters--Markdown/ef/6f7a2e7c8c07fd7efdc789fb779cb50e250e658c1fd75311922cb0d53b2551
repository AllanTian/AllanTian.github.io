I";<p>在逛 Stack Overflow 的时候，发现最火的问题竟然是：<a href="http://www.itwanger.com/java/2019/12/03/java-null-pointer-exception.html">什么是 NullPointerException</a>（<code class="highlighter-rouge">java.lang.NullPointerException</code>），它是由什么原因导致的，有没有好的方法或者工具可以追踪它发生的原因？</p>

<!--more-->

<p>真没想到，这个问题浏览的次数多达 250 万次！所以，我想是时候把最高赞的回答整理一下分享出来了。请随我来。</p>

<p>声明引用变量（即对象）时，实际上是创建了一个指向对象的指针。请看以下代码：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">x</span><span class="o">;</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
</code></pre></div></div>

<p>第一行代码声明了一个名为 x 的变量（int 类型），Java 会把它初始化为 0。第二行代码把 x 赋值为 10，意味着 10 将被写入到 x 所指向的内存位置上。</p>

<p>但是呢，当我们尝试声明一个引用类型时，情况将会有所不同。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Integer</span> <span class="n">num</span><span class="o">;</span>
<span class="n">num</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Integer</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
</code></pre></div></div>

<p>第一行代码声明了一个名为 num 的变量（Integer 类型），Java 把它初始化为 null，表示“什么都没有指向 ”。</p>

<p>第二行代码中，new 关键字创建了一个 Integer 类型的对象，并将变量 num 指向该对象。</p>

<p>当我们声明了一个变量，却没有将该变量指向任何创建的对象，然后就使用它的时候，NullPointerException 就发生了。大多数情况下，编译器会发现这个问题，并且提醒我们“xxxx may not have been initialized”。</p>

<p>假如有这样一段代码：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomething</span><span class="o">(</span><span class="nc">SomeObject</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
   <span class="c1">//do something to obj</span>
<span class="o">}</span>
</code></pre></div></div>

<p>在这种情况下，我们没有创建对象 obj，而是假设它在 <code class="highlighter-rouge">doSomething()</code> 方法被调用之前就创建了。</p>

<p>现在假设在此之前它没有创建。我们这样调用 <code class="highlighter-rouge">doSomething()</code> 方法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">doSomething</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</code></pre></div></div>

<p>这就意味着 <code class="highlighter-rouge">doSomething()</code> 方法的参数 obj 为 null。如果该方法还要使用 obj 继续做点什么，最好提前抛出 <code class="highlighter-rouge">NullPointerException</code>，因为开发者需要该信息来进行调试。</p>

<p>还有另外一种替代方法，判断 obj 是不是 null，如果是，就小心行事，做某些不会引起 NullPointerException 的事情；如果不是，就放心大胆地做该做的事情。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
  * @param obj An optional foo for ____. May be null, in which case 
  *  the result will be ____.
  */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomething</span><span class="o">(</span><span class="nc">SomeObject</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">obj</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
       <span class="c1">//do something</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
       <span class="c1">//do something else</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>那假如程序真的出现了 NullPointerException，该怎么追踪堆栈信息，找到错误的根源呢？</p>

<p>简单来说，堆栈信息是应用程序在引发 Exception 时调用的方法列表，可以准确地定位到错误发生的根源。就像下面这样。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Exception in thread "main" java.lang.NullPointerException
        at com.example.myproject.Book.getTitle(Book.java:16)
        at com.example.myproject.Author.getBookTitles(Author.java:25)
        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)
</code></pre></div></div>

<p>就上面这个堆栈信息来说，错误发生在“at …”列表处，第一个“at 处”就是错误最初发生的位置。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>at com.example.myproject.Book.getTitle(Book.java:16)
</code></pre></div></div>

<p>为了调试，我们可以打开 Book.java 类的第 16 行，它可能是：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">15</span>   <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getTitle</span><span class="o">()</span> <span class="o">{</span>
<span class="mi">16</span>      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">title</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
<span class="mi">17</span>      <span class="k">return</span> <span class="n">title</span><span class="o">;</span>
<span class="mi">18</span>   <span class="o">}</span>
</code></pre></div></div>

<p>从这段代码中可以看得出，错误的原因很可能是因为 title 为 null。</p>

<p>有时候，应用程序会捕获一个异常，然后把它作为另外一种类型的异常抛出。就像下面这样：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">34</span>   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">getBookIds</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
<span class="mi">35</span>      <span class="k">try</span> <span class="o">{</span>
<span class="mi">36</span>         <span class="n">book</span><span class="o">.</span><span class="na">getId</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>    <span class="c1">// 这里可能会引发 NullPointerException</span>
<span class="mi">37</span>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NullPointerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="mi">38</span>         <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalStateException</span><span class="o">(</span><span class="s">"A book has a null property"</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span>
<span class="mi">39</span>      <span class="o">}</span>
<span class="mi">40</span>   <span class="o">}</span>
</code></pre></div></div>

<p>此时的堆栈信息可能是下面这样的：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Exception in thread "main" java.lang.IllegalStateException: A book has a null property
        at com.example.myproject.Author.getBookIds(Author.java:38)
        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)
Caused by: java.lang.NullPointerException
        at com.example.myproject.Book.getId(Book.java:22)
        at com.example.myproject.Author.getBookIds(Author.java:36)
        ... 1 more
</code></pre></div></div>

<p>和之前堆栈信息有所不同的是，这里多了一个“Caused by”；有时候还会有更多的“Caused by”。在这种情况下，我们通常需要追本溯源，找到最深层次的那个“cause”——它就是堆栈信息中最下面的那个。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Caused by: java.lang.NullPointerException &lt;-- 根本原因
        at com.example.myproject.Book.getId(Book.java:22) 
</code></pre></div></div>

<p>同样，我们需要查看一下 Book.java 的第 22 行，找到可能引发 <code class="highlighter-rouge">NullPointerException</code> 的原因。</p>

<p>有时候，堆栈信息要比上面的例子凌乱得多。参考下面这个。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>javax.servlet.ServletException: Something bad happened
    at com.example.myproject.OpenSessionInViewFilter.doFilter(OpenSessionInViewFilter.java:60)
    at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1157)
    at com.example.myproject.ExceptionHandlerFilter.doFilter(ExceptionHandlerFilter.java:28)
    at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1157)
    at com.example.myproject.OutputBufferFilter.doFilter(OutputBufferFilter.java:33)
    at org.mortbay.jetty.Server.handle(Server.java:326)
    at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:542)
    at org.mortbay.jetty.HttpConnection$RequestHandler.content(HttpConnection.java:943)
    at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:756)
    at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:218)
    at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:404)
    at org.mortbay.jetty.bio.SocketConnector$Connection.run(SocketConnector.java:228)
    at org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582)
Caused by: com.example.myproject.MyProjectServletException
    at com.example.myproject.MyServlet.doPost(MyServlet.java:169)
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:727)
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:820)
    at org.mortbay.jetty.servlet.ServletHolder.handle(ServletHolder.java:511)
    at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1166)
    at org.hibernate.persister.entity.AbstractEntityPersister.insert(AbstractEntityPersister.java:2822)
    at org.hibernate.action.EntityIdentityInsertAction.execute(EntityIdentityInsertAction.java:71)
    at org.hibernate.engine.ActionQueue.execute(ActionQueue.java:268)
    at org.hibernate.event.def.AbstractSaveEventListener.performSaveOrReplicate(AbstractSaveEventListener.java:321)
    at org.hibernate.event.def.AbstractSaveEventListener.performSave(AbstractSaveEventListener.java:204)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
    at java.lang.reflect.Method.invoke(Method.java:597)
    at org.hibernate.context.ThreadLocalSessionContext$TransactionProtectionWrapper.invoke(ThreadLocalSessionContext.java:344)
    at $Proxy19.save(Unknown Source)
    at com.example.myproject.MyEntityService.save(MyEntityService.java:59) &lt;-- relevant call (see notes below)
    at com.example.myproject.MyServlet.doPost(MyServlet.java:164)
    ... 32 more
Caused by: java.sql.SQLException: Violation of unique constraint MY_ENTITY_UK_1: duplicate value(s) for column(s) MY_COLUMN in statement [...]
    at org.hsqldb.jdbc.Util.throwError(Unknown Source)
    at org.hsqldb.jdbc.jdbcPreparedStatement.executeUpdate(Unknown Source)
    at com.mchange.v2.c3p0.impl.NewProxyPreparedStatement.executeUpdate(NewProxyPreparedStatement.java:105)
    at org.hibernate.id.insert.AbstractSelectingDelegate.performInsert(AbstractSelectingDelegate.java:57)
    ... 54 more
</code></pre></div></div>

<p>这个例子当中的堆栈信息实在是太多了，令人眼花缭乱。如果按照之前提供的方法（堆栈信息中最下面的那个）找最深层次的那个“cause”，它就是：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Caused by: java.sql.SQLException: Violation of unique constraint MY_ENTITY_UK_1: duplicate value(s) for column(s) MY_COLUMN in statement [...]
    at org.hsqldb.jdbc.Util.throwError(Unknown Source)
    at org.hsqldb.jdbc.jdbcPreparedStatement.executeUpdate(Unknown Source)
    at com.mchange.v2.c3p0.impl.NewProxyPreparedStatement.executeUpdate(NewProxyPreparedStatement.java:105)
    at org.hibernate.id.insert.AbstractSelec
</code></pre></div></div>

<p>但其实它并不是的，因为抛出这个异常的方法调用者属于类库代码（c3p0 类库），所以我们需要往上找异常发生的原因，并且这个异常很可能是由我们自己编写的代码（<code class="highlighter-rouge">com.example.myproject</code> 包下）引发的，于是我们找到了这样一段异常信息。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">myproject</span><span class="o">.</span><span class="na">MyEntityService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="nc">MyEntityService</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">59</span><span class="o">)</span>
</code></pre></div></div>

<p>顺藤摸瓜，看看 MyEntityService.java 的第 59 行，它就是引发错误的根本原因。</p>

<p>好了各位读者朋友们，以上就是本文的全部内容了。<strong>能看到这里的都是人才，二哥必须要为你点个赞</strong>👍。如果觉得不过瘾，还想看到更多，可以查看我的<a href="http://www.itwanger.com/">个人博客</a>。另外呢，给大家一个承诺，我每周都会更新一篇《程序人生》和一篇 Java 技术栈相关的文章，敬请期待。如果你有什么问题需要我的帮助，或者想喷我了，欢迎留言哟。</p>

<p>养成好习惯！如果觉得这篇文章有点用的话，<strong>求点赞、求关注、求分享、求留言</strong>，这将是我写下去的最强动力！如果大家想要第一时间看到二哥更新的文章，可以扫描下方的二维码，关注我的公众号。我们下篇文章见！</p>

:ET